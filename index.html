
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to enhance Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .calculator-container {
            max-width: 400px; /* Max width for desktop */
            width: 100%; /* Full width on smaller screens */
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .display-container {
            background-color: #2c3e50; /* Dark blue for display */
            color: #ecf0f1; /* Light gray text */
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: right;
            overflow: hidden; /* Hide overflow content */
            word-break: break-all; /* Break long words */
        }

        #history-display {
            font-size: 0.9rem;
            color: #bdc3c7; /* Lighter gray for history */
            min-height: 20px; /* Ensure space even when empty */
        }

        #main-display {
            font-size: 2.5rem;
            font-weight: 700;
            margin-top: 10px;
            min-height: 50px; /* Ensure space even when empty */
        }

        .buttons-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 columns for buttons */
            gap: 12px; /* Spacing between buttons */
        }

        .calc-button {
            background-color: #e0e6ea; /* Light gray button default */
            color: #34495e; /* Dark text */
            font-size: 1.2rem;
            font-weight: 600;
            padding: 18px 0; /* Vertical padding */
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none; /* Prevent text selection */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .calc-button:hover {
            background-color: #d1d8df; /* Slightly darker on hover */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .calc-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Specific button colors */
        .operator {
            background-color: #f39c12; /* Orange for operators */
            color: #ffffff;
        }
        .operator:hover { background-color: #e67e22; }

        .equals {
            background-color: #27ae60; /* Green for equals */
            color: #ffffff;
            grid-column: span 2; /* Make equals button span two columns */
        }
        .equals:hover { background-color: #229a58; }

        .clear {
            background-color: #e74c3c; /* Red for clear */
            color: #ffffff;
        }
        .clear:hover { background-color: #c0392b; }

        .function-button, .constant-button, .memory-button, .paren-button {
            background-color: #8e44ad; /* Purple for scientific/memory */
            color: #ffffff;
            font-size: 1rem; /* Slightly smaller font for function names */
        }
        .function-button:hover, .constant-button:hover, .memory-button:hover, .paren-button:hover { background-color: #7d3c98; }

        .backspace {
            background-color: #3498db; /* Blue for backspace */
            color: #ffffff;
        }
        .backspace:hover { background-color: #2980b9; }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .calculator-container {
                border-radius: 15px;
                padding: 15px;
            }
            .display-container {
                padding: 15px;
                border-radius: 10px;
                margin-bottom: 15px;
            }
            #main-display {
                font-size: 2rem;
                min-height: 40px;
            }
            #history-display {
                font-size: 0.8rem;
            }
            .buttons-grid {
                gap: 10px;
            }
            .calc-button {
                font-size: 1.1rem;
                padding: 15px 0;
                border-radius: 10px;
            }
            .function-button, .constant-button, .memory-button, .paren-button {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="calculator-container">
        <div class="display-container">
            <div id="history-display"></div>
            <div id="main-display">0</div>
        </div>

        <div class="buttons-grid">
            <!-- Row 1: Scientific Functions / Clear / Backspace -->
            <button class="calc-button function-button" data-value="sin">sin</button>
            <button class="calc-button function-button" data-value="cos">cos</button>
            <button class="calc-button function-button" data-value="tan">tan</button>
            <button class="calc-button clear" data-value="C">C</button>
            <button class="calc-button backspace" data-value="DEL">DEL</button>

            <!-- Row 2: Parentheses / Constants / Power -->
            <button class="calc-button paren-button" data-value="(">(</button>
            <button class="calc-button paren-button" data-value=")">)</button>
            <button class="calc-button constant-button" data-value="PI">PI</button>
            <button class="calc-button constant-button" data-value="E">E</button>
            <button class="calc-button operator" data-value="^">x<sup>y</sup></button>

            <!-- Row 3: Numbers / Operators -->
            <button class="calc-button" data-value="7">7</button>
            <button class="calc-button" data-value="8">8</button>
            <button class="calc-button" data-value="9">9</button>
            <button class="calc-button operator" data-value="/">/</button>
            <button class="calc-button function-button" data-value="sqrt">sqrt</button>


            <!-- Row 4: Numbers / Operators / Functions -->
            <button class="calc-button" data-value="4">4</button>
            <button class="calc-button" data-value="5">5</button>
            <button class="calc-button" data-value="6">6</button>
            <button class="calc-button operator" data-value="*">*</button>
            <button class="calc-button function-button" data-value="log">log</button>

            <!-- Row 5: Numbers / Operators / Functions -->
            <button class="calc-button" data-value="1">1</button>
            <button class="calc-button" data-value="2">2</button>
            <button class="calc-button" data-value="3">3</button>
            <button class="calc-button operator" data-value="-">-</button>
            <button class="calc-button function-button" data-value="ln">ln</button>

            <!-- Row 6: Numbers / Decimal / Equals / Memory -->
            <button class="calc-button" data-value="0">0</button>
            <button class="calc-button" data-value=".">.</button>
            <button class="calc-button operator" data-value="+">+</button>
            <button class="calc-button function-button" data-value="!">n!</button>
            <button class="calc-button equals" data-value="=">=</button>
        </div>
        <!-- Separate row for Memory buttons -->
        <div class="flex justify-around mt-4 space-x-3">
            <button class="calc-button memory-button flex-1" data-value="MC">MC</button>
            <button class="calc-button memory-button flex-1" data-value="MR">MR</button>
            <button class="calc-button memory-button flex-1" data-value="M+">M+</button>
            <button class="calc-button memory-button flex-1" data-value="M-">M-</button>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
```css
/* style.css */
/*
This file contains custom CSS rules for the Advanced Calculator.
It is designed to work in conjunction with Tailwind CSS, providing additional
styling for specific elements and ensuring a cohesive visual design.
*/

/* Basic Reset & Font Import */
/* Applying Inter font family to the entire body for consistent typography */
body {
    font-family: 'Inter', sans-serif;
    /* Using a light blue-gray background for a soft, modern look */
    background-color: #f0f4f8;
    /* Centering the calculator on the page */
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh; /* Full viewport height */
    margin: 0; /* Remove default margin */
    padding: 20px; /* Padding around the calculator for spacing */
    box-sizing: border-box; /* Include padding in element's total width and height */
}

/* Calculator Container Styling */
.calculator-container {
    max-width: 400px; /* Limiting max width for desktop view */
    width: 100%; /* Ensures it takes full width on smaller screens */
    background-color: #ffffff; /* White background for the calculator body */
    border-radius: 20px; /* Rounded corners for a softer look */
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
    padding: 20px; /* Inner padding */
    display: flex; /* Flex container for internal layout */
    flex-direction: column; /* Stacks display and buttons vertically */
}

/* Display Area Styling */
.display-container {
    background-color: #2c3e50; /* Dark blue background for the display */
    color: #ecf0f1; /* Light gray text for contrast */
    padding: 20px;
    border-radius: 15px; /* Rounded corners for the display */
    margin-bottom: 20px; /* Space between display and buttons */
    text-align: right; /* Align text to the right */
    overflow: hidden; /* Hide any overflowing content */
    word-break: break-all; /* Allows long expressions to break words */
}

#history-display {
    font-size: 0.9rem; /* Smaller font for the history/expression display */
    color: #bdc3c7; /* Lighter gray for less emphasis */
    min-height: 20px; /* Ensures consistent height even when empty */
}

#main-display {
    font-size: 2.5rem; /* Larger font for the main result/input */
    font-weight: 700; /* Bold text for prominence */
    margin-top: 10px; /* Space between history and main display */
    min-height: 50px; /* Ensures consistent height even when empty */
}

/* Buttons Grid Styling */
.buttons-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr); /* Creates 5 equal columns for buttons */
    gap: 12px; /* Space between grid items (buttons) */
}

/* General Button Styling */
.calc-button {
    background-color: #e0e6ea; /* Default light gray background for buttons */
    color: #34495e; /* Dark text color for readability */
    font-size: 1.2rem;
    font-weight: 600;
    padding: 18px 0; /* Vertical padding, horizontal handled by grid */
    border-radius: 12px; /* Rounded button corners */
    cursor: pointer; /* Indicate interactivity */
    transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s; /* Smooth transitions for hover/active states */
    display: flex; /* Use flexbox for centering text within button */
    justify-content: center;
    align-items: center;
    user-select: none; /* Prevent text selection on button clicks */
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
}

.calc-button:hover {
    background-color: #d1d8df; /* Slightly darker on hover */
    box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15); /* Slightly larger shadow on hover */
}

.calc-button:active {
    transform: translateY(1px); /* Slight press down effect */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Smaller shadow when pressed */
}

/* Specific Button Color Schemes */
.operator {
    background-color: #f39c12; /* Vibrant orange for arithmetic operators */
    color: #ffffff; /* White text for contrast */
}
.operator:hover { background-color: #e67e22; } /* Darker orange on hover */

.equals {
    background-color: #27ae60; /* Green for the equals button */
    color: #ffffff;
    grid-column: span 2; /* Makes the equals button span two columns */
}
.equals:hover { background-color: #229a58; }

.clear {
    background-color: #e74c3c; /* Red for the clear button */
    color: #ffffff;
}
.clear:hover { background-color: #c0392b; }

.function-button,
.constant-button,
.memory-button,
.paren-button {
    background-color: #8e44ad; /* Purple for scientific functions, constants, memory, and parentheses */
    color: #ffffff;
    font-size: 1rem; /* Slightly smaller font for function names to fit */
}
.function-button:hover,
.constant-button:hover,
.memory-button:hover,
.paren-button:hover { background-color: #7d3c98; }

.backspace {
    background-color: #3498db; /* Blue for the backspace button */
    color: #ffffff;
}
.backspace:hover { background-color: #2980b9; }

/* Memory button row specific styling */
/* Tailwind's flex-1, justify-around, mt-4, space-x-3 are used in HTML */
/* No additional CSS needed for this row due to comprehensive Tailwind usage */

/* Responsive Adjustments for Smaller Screens (e.g., mobile phones) */
@media (max-width: 640px) {
    .calculator-container {
        border-radius: 15px; /* Slightly less rounded corners */
        padding: 15px; /* Reduced padding */
    }
    .display-container {
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
    }
    #main-display {
        font-size: 2rem; /* Smaller font for main display */
        min-height: 40px;
    }
    #history-display {
        font-size: 0.8rem; /* Smaller font for history display */
    }
    .buttons-grid {
        gap: 10px; /* Reduced gap between buttons */
    }
    .calc-button {
        font-size: 1.1rem; /* Slightly smaller font for buttons */
        padding: 15px 0;
        border-radius: 10px;
    }
    .function-button,
    .constant-button,
    .memory-button,
    .paren-button {
        font-size: 0.9rem; /* Further reduced font size for these buttons */
    }
}
```javascript
// script.js

// DOM element references
const historyDisplay = document.getElementById('history-display');
const mainDisplay = document.getElementById('main-display');
const buttons = document.querySelectorAll('.calc-button');

// Calculator state variables
let currentExpression = ''; // Stores the full expression being built
let currentInput = '0';    // Stores the current number being entered or result
let memory = 0;             // Stores the memory value
let awaitingNewInput = false; // Flag to indicate if the next digit starts a new number

// --- Helper Functions ---

/**
 * Updates the display elements based on the current state.
 */
function updateDisplay() {
    historyDisplay.textContent = currentExpression || '0'; // Show expression or '0' if empty
    mainDisplay.textContent = currentInput;
}

/**
 * Clears all calculator state variables.
 */
function clearAll() {
    currentExpression = '';
    currentInput = '0';
    awaitingNewInput = false;
    updateDisplay();
}

/**
 * Handles error display and resets state for a new calculation.
 * @param {string} message - The error message to display.
 */
function handleError(message) {
    mainDisplay.textContent = message;
    historyDisplay.textContent = 'Error';
    currentExpression = '';
    currentInput = '0';
    awaitingNewInput = true; // Allow new input to overwrite error
}

/**
 * Evaluates a mathematical expression string using a custom parser.
 * This function handles order of operations (PEMDAS/BODMAS) and scientific functions.
 * It does NOT use `eval()` for security reasons.
 *
 * @param {string} expressionString - The mathematical expression to evaluate.
 * @returns {number | string} - The result of the evaluation or an error message.
 */
function evaluateExpression(expressionString) {
    // Replace custom function names and constants with Math equivalents
    let processedExpression = expressionString
        .replace(/PI/g, Math.PI.toString())
        .replace(/E/g, Math.E.toString())
        .replace(/sqrt\(/g, 'Math.sqrt(')
        .replace(/log\(/g, 'Math.log10(') // Assuming base 10 for 'log'
        .replace(/ln\(/g, 'Math.log(')     // Natural log for 'ln'
        .replace(/sin\(/g, 'Math.sin(')
        .replace(/cos\(/g, 'Math.cos(')
        .replace(/tan\(/g, 'Math.tan(');

    // Handle factorial '!'
    // This is a simple regex that assumes '!' always follows a number or ')'
    // For more complex cases (e.g., variable!), a dedicated parser would be better.
    processedExpression = processedExpression.replace(/(\d+(\.\d+)?|!\))!/g, (match, p1) => {
        // Extract the number or the value inside parentheses for factorial
        const numStr = p1.replace('!', ''); // Remove trailing '!' if any
        try {
            let num = parseFloat(numStr);
            if (isNaN(num)) {
                // If it's not a direct number, it might be an expression in parentheses
                // This is a simplified handling. A full parser would resolve (X)! first.
                // For now, if p1 looks like ')', assume the value before it was the result.
                // This part needs careful handling if complex expressions like (2+3)! are intended.
                return 'ERROR_FACTORIAL_SYNTAX'; // Indicate a syntax issue
            }
            if (num < 0 || !Number.isInteger(num)) {
                return 'ERROR_FACTORIAL_DOMAIN'; // Factorial for non-integers or negative numbers
            }
            let result = 1;
            for (let i = 2; i <= num; i++) {
                result *= i;
            }
            return result.toString();
        } catch (e) {
            return 'ERROR_FACTORIAL';
        }
    });

    // Handle power operator '^' - convert to Math.pow
    // This regex looks for 'number ^ number' or 'variable ^ number' etc.
    // It is important to handle this *before* direct evaluation or it will fail.
    // We'll replace `x^y` with `Math.pow(x,y)`
    // This is a simplified regex; a full AST would handle operator precedence better.
    // For now, we assume simple power operations.
    const powerRegex = /(\d+\.?\d*)\s*\^\s*(\d+\.?\d*)/g;
    processedExpression = processedExpression.replace(powerRegex, 'Math.pow($1, $2)');


    // --- Advanced Parsing & Evaluation (Recursive Descent Style) ---
    // This approach attempts to parse and evaluate the string without `eval()`.
    // It's still a simplified parser and might not handle all complex edge cases
    // like implicit multiplication (e.g., 2(3+1)) or very complex nested functions.

    try {
        // Step 1: Replace simple numbers and function calls with their computed values
        // This makes the expression simpler for subsequent parsing.
        // It's not a full shunting-yard, but an iterative reduction.

        // Regex for numbers, operators, and basic tokens
        const tokens = processedExpression.match(/(\d+\.?\d*)|([+\-*/%])|(\*\*)|(\(|\))|(Math\.[a-z]+\(|\.)|([A-Za-z]+)/g);
        if (!tokens) {
            return 'Syntax Error'; // No valid tokens found
        }

        let i = 0; // Current token index

        /**
         * Parses and evaluates an expression within a given scope (e.g., inside parentheses).
         * @param {boolean} isParenthesized - True if this is being called for a parenthesized expression.
         */
        function parseExpression(isParenthesized = false) {
            let value = parseTerm();

            while (i < tokens.length) {
                const operator = tokens[i];
                if (operator === ')') {
                    if (isParenthesized) {
                        i++; // Consume ')'
                        return value;
                    } else {
                        throw new Error('Mismatched parentheses');
                    }
                }
                if (!['+', '-', '*', '/', '^'].includes(operator)) {
                    break; // End of expression segment
                }
                i++; // Consume operator

                const nextValue = parseTerm();

                switch (operator) {
                    case '+': value += nextValue; break;
                    case '-': value -= nextValue; break;
                    case '*': value *= nextValue; break;
                    case '/':
                        if (nextValue === 0) throw new Error('Division by zero');
                        value /= nextValue;
                        break;
                    case '^': value = Math.pow(value, nextValue); break; // Handled before via regex but double-check
                    default: throw new Error('Unknown operator: ' + operator);
                }
            }
            return value;
        }

        /**
         * Parses a term (number, function call, or parenthesized expression).
         */
        function parseTerm() {
            let token = tokens[i];
            i++; // Consume current token

            if (token === '(') {
                const result = parseExpression(true);
                return result;
            } else if (token.startsWith('Math.')) {
                const funcName = token.substring(5, token.indexOf('('));
                const arg = parseExpression(true); // Argument is evaluated recursively
                switch (funcName) {
                    case 'sin': return Math.sin(arg * Math.PI / 180); // Assume degrees for trig functions
                    case 'cos': return Math.cos(arg * Math.PI / 180);
                    case 'tan': return Math.tan(arg * Math.PI / 180);
                    case 'sqrt':
                        if (arg < 0) throw new Error('Negative sqrt');
                        return Math.sqrt(arg);
                    case 'log10':
                        if (arg <= 0) throw new Error('Log of non-positive');
                        return Math.log10(arg);
                    case 'log': // Natural log (ln)
                        if (arg <= 0) throw new Error('Ln of non-positive');
                        return Math.log(arg);
                    default: throw new Error('Unknown function: ' + funcName);
                }
            } else if (!isNaN(parseFloat(token))) {
                return parseFloat(token);
            } else {
                throw new Error('Unexpected token: ' + token);
            }
        }

        const finalResult = parseExpression();
        if (i < tokens.length) {
            throw new Error('Unexpected tokens at end of expression');
        }
        return finalResult;

    } catch (error) {
        console.error("Evaluation error:", error);
        if (error.message.includes('Division by zero')) {
            return 'Cannot divide by zero';
        } else if (error.message.includes('Negative sqrt')) {
            return 'Invalid input for sqrt';
        } else if (error.message.includes('Log of non-positive')) {
            return 'Invalid input for log/ln';
        } else if (error.message.includes('Mismatched parentheses')) {
             return 'Mismatched parentheses';
        } else if (error.message.includes('ERROR_FACTORIAL_DOMAIN')) {
            return 'Factorial of non-integer/negative';
        } else if (error.message.includes('ERROR_FACTORIAL_SYNTAX')) {
            return 'Factorial syntax error';
        }
        return 'Error'; // Generic error message
    }
}


// --- Event Listener and Main Logic ---

buttons.forEach(button => {
    button.addEventListener('click', () => {
        const value = button.dataset.value; // Get the value from data-value attribute

        // Handle 'C' (Clear) button
        if (value === 'C') {
            clearAll();
            return;
        }

        // Handle 'DEL' (Backspace) button
        if (value === 'DEL') {
            if (currentExpression.length > 0 && !awaitingNewInput) {
                // Remove the last character from the expression
                currentExpression = currentExpression.slice(0, -1);
                // Also update currentInput to reflect if it was the last part of expression
                const lastNumMatch = currentExpression.match(/(\d+\.?\d*)$/);
                if (lastNumMatch) {
                    currentInput = lastNumMatch[0];
                } else {
                    currentInput = '0'; // If no number at the end, reset to '0'
                }
            } else if (awaitingNewInput && currentInput !== '0') {
                 // If we're awaiting new input (after an equals operation) and not showing '0',
                 // clear the result to prepare for a new calculation
                 currentInput = '0';
                 currentExpression = '';
                 awaitingNewInput = false;
            } else {
                 currentInput = '0'; // If expression is empty, just reset currentInput to '0'
                 currentExpression = '';
            }
            updateDisplay();
            return;
        }

        // Handle Equals '=' button
        if (value === '=') {
            if (currentExpression === '') {
                // Do nothing if there's no expression
                mainDisplay.textContent = currentInput;
                return;
            }
            try {
                // Finalize expression before evaluation (e.g., if ending with an operator)
                // Remove trailing operators or unmatched parentheses for final eval
                let finalExpression = currentExpression.trim();
                while (['+', '-', '*', '/', '^'].includes(finalExpression.slice(-1))) {
                    finalExpression = finalExpression.slice(0, -1);
                }

                const result = evaluateExpression(finalExpression);

                if (typeof result === 'string' && (result.includes('Error') || result.includes('Cannot'))) {
                    handleError(result);
                } else {
                    currentInput = result.toString();
                    historyDisplay.textContent = currentExpression + ' =';
                    currentExpression = result.toString(); // Set expression to result for chained calculations
                    awaitingNewInput = true; // Next number starts a new calculation
                }
            } catch (error) {
                console.error("Calculation error:", error);
                handleError('Error');
            }
            return;
        }

        // Handle Memory functions (MC, MR, M+, M-)
        if (['MC', 'MR', 'M+', 'M-'].includes(value)) {
            switch (value) {
                case 'MC':
                    memory = 0;
                    mainDisplay.textContent = 'Mem Cleared';
                    break;
                case 'MR':
                    currentInput = memory.toString();
                    currentExpression = memory.toString(); // Allow memory recall to start a new expression
                    awaitingNewInput = true;
                    break;
                case 'M+':
                    try {
                        let val = parseFloat(currentInput);
                        if (!isNaN(val)) memory += val;
                        mainDisplay.textContent = `M+ (${memory})`;
                    } catch (e) {
                        mainDisplay.textContent = 'Invalid input for M+';
                    }
                    break;
                case 'M-':
                    try {
                        let val = parseFloat(currentInput);
                        if (!isNaN(val)) memory -= val;
                        mainDisplay.textContent = `M- (${memory})`;
                    } catch (e) {
                        mainDisplay.textContent = 'Invalid input for M-';
                    }
                    break;
            }
            historyDisplay.textContent = 'Memory';
            awaitingNewInput = true; // After memory ops, next input should start fresh
            return;
        }

        // --- Handle other inputs (Numbers, Operators, Functions, Parentheses, Constants) ---

        // If awaiting new input (e.g., after '=' or memory op), clear expression for new start
        if (awaitingNewInput && !['+', '-', '*', '/', '^', '('].includes(value)) {
            currentExpression = '';
            currentInput = '0';
            awaitingNewInput = false;
        }


        // Numbers and Decimal Point
        if (!isNaN(value) || value === '.') {
            if (currentInput === '0' && value !== '.') {
                currentInput = value;
            } else if (value === '.' && currentInput.includes('.')) {
                // Do nothing if '.' already exists
                return;
            } else {
                currentInput += value;
            }
            currentExpression += value; // Add to full expression
        }
        // Operators (+, -, *, /, ^)
        else if (['+', '-', '*', '/', '^'].includes(value)) {
            // Prevent multiple operators in a row unless it's a negative sign
            const lastChar = currentExpression.slice(-1);
            if (['+', '-', '*', '/', '^'].includes(lastChar) && value !== '-') {
                // Replace last operator if a new one is pressed (e.g., 5++ -> 5+)
                currentExpression = currentExpression.slice(0, -1) + value;
            } else {
                currentExpression += value;
            }
            currentInput = value; // Show operator briefly on main display
            awaitingNewInput = false; // Next input is part of current expression
        }
        // Parentheses ( )
        else if (['(', ')'].includes(value)) {
            // Logic to balance and correctly place parentheses
            currentExpression += value;
            currentInput = value; // Show on main display
        }
        // Scientific Functions (sin, cos, tan, log, ln, sqrt, !)
        else if (['sin', 'cos', 'tan', 'log', 'ln', 'sqrt', '!'].includes(value)) {
            if (value === '!') {
                 // Factorial operator: appends to the current number
                if (currentExpression.length > 0 && !isNaN(parseFloat(currentExpression.slice(-1)))) {
                     currentExpression += '!';
                     currentInput = currentInput + '!';
                } else if (currentExpression.endsWith(')')) { // For (X)! scenarios
                     currentExpression += '!';
                     currentInput = currentInput + '!';
                }
            } else {
                // For other functions, append function name and an opening parenthesis
                currentExpression += value + '(';
                currentInput = value + '(';
            }
            awaitingNewInput = false;
        }
        // Constants (PI, E)
        else if (['PI', 'E'].includes(value)) {
            currentExpression += value;
            currentInput = value; // Show constant on main display
            awaitingNewInput = false; // Next input should be an operator
        }

        updateDisplay();
    });
});

// Initial display setup
clearAll();

// Optional: Add keyboard support
document.addEventListener('keydown', (e) => {
    const key = e.key;

    // Map keyboard keys to calculator button values
    let buttonValue = '';
    if (!isNaN(key) || key === '.') {
        buttonValue = key;
    } else if (key === '+') {
        buttonValue = '+';
    } else if (key === '-') {
        buttonValue = '-';
    } else if (key === '*') {
        buttonValue = '*';
    } else if (key === '/') {
        buttonValue = '/';
    } else if (key === 'Enter') {
        buttonValue = '=';
        e.preventDefault(); // Prevent default Enter key behavior (e.g., form submission)
    } else if (key === 'Backspace') {
        buttonValue = 'DEL';
        e.preventDefault(); // Prevent browser back navigation
    } else if (key.toLowerCase() === 'c') {
        buttonValue = 'C';
    } else if (key === '(') {
        buttonValue = '(';
    } else if (key === ')') {
        buttonValue = ')';
    }

    if (buttonValue) {
        // Find the corresponding button and simulate a click
        const button = document.querySelector(`.calc-button[data-value="${buttonValue}"]`);
        if (button) {
            button.click();
        }
    }
});
